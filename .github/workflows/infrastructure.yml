# ============================================
# PIPELINE DE INFRAESTRUCTURA - TERRAFORM
# ============================================
# Rebuild VM - SSH configuration fix

name: ğŸ—ï¸ Infrastructure Pipeline

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'AcciÃ³n a ejecutar'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - deploy
        - destroy
        - clean-deploy
      
  push:
    branches:
      - feature/infrastructure-setup
    paths:
      - 'terraform/**'
  
  pull_request:
    paths:
      - 'terraform/**'

env:
  TF_VERSION: '1.5.0'
  WORKING_DIRECTORY: './terraform'

jobs:
  # ============================================
  # VALIDACIÃ“N Y PLAN
  # ============================================
  terraform-plan:
    name: ğŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    outputs:
      plan-exists: ${{ steps.plan.outputs.plan-exists }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ“‚ Terraform Init
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        terraform init
        
    - name: âœ… Terraform Validate
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: terraform validate

    - name: ğŸ¯ Terraform Format Check
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: terraform fmt -check=true -diff=true

    - name: ğŸ“‹ Terraform Plan
      id: plan
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        terraform plan -detailed-exitcode -out=tfplan
        echo "plan-exists=true" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: ğŸ“¤ Upload Plan
      if: steps.plan.outputs.plan-exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan
        path: ${{ env.WORKING_DIRECTORY }}/tfplan
        retention-days: 1

    - name: ğŸ’¬ Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const output = `
          ## ğŸ—ï¸ Terraform Plan Results
          
          âœ… **Terraform Format and Style**: ${{ steps.plan.outcome }}
          âœ… **Terraform Initialization**: Successful
          âœ… **Terraform Validation**: Successful
          âœ… **Terraform Plan**: ${{ steps.plan.outcome }}
          
          <details><summary>Show Plan Output</summary>
          
          \`\`\`
          ${{ steps.plan.outputs.stdout }}
          \`\`\`
          
          </details>
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

  # ============================================
  # DESPLIEGUE DE INFRAESTRUCTURA
  # ============================================
  terraform-deploy:
    name: ğŸš€ Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: >
      (github.event.inputs.action == 'deploy' || 
       (github.ref == 'refs/heads/feature/infrastructure-setup' && github.event_name == 'push')) &&
      needs.terraform-plan.outputs.plan-exists == 'true'
    
    environment: 
      name: azure-production
      url: ${{ steps.terraform-output.outputs.application_url }}

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ“¥ Download Plan
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan
        path: ${{ env.WORKING_DIRECTORY }}

    - name: ğŸ“‚ Terraform Init
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: terraform init

    - name: ğŸš€ Terraform Apply
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        terraform apply -auto-approve tfplan
        
    - name: ğŸ“Š Get Terraform Outputs
      id: terraform-output
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        echo "application_url=$(terraform output -raw application_url)" >> $GITHUB_OUTPUT
        echo "dashboard_url=$(terraform output -raw dashboard_url)" >> $GITHUB_OUTPUT
        echo "ssh_command=$(terraform output -raw ssh_connection_command)" >> $GITHUB_OUTPUT
        echo "public_ip=$(terraform output -raw public_ip_address)" >> $GITHUB_OUTPUT

    - name: ğŸ‰ Deployment Success
      run: |
        echo "ğŸ‰ Â¡DESPLIEGUE EXITOSO!"
        echo "ğŸŒ AplicaciÃ³n: ${{ steps.terraform-output.outputs.application_url }}"
        echo "ğŸ“Š Dashboard: ${{ steps.terraform-output.outputs.dashboard_url }}"
        echo "ğŸ”— SSH: ${{ steps.terraform-output.outputs.ssh_command }}"
        echo "ğŸ“± IP: ${{ steps.terraform-output.outputs.public_ip }}"

    - name: ğŸ’¬ Post Success Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const output = `
          ## ğŸ‰ Despliegue Exitoso!
          
          ### ğŸŒ AplicaciÃ³n Desplegada:
          - **AplicaciÃ³n**: ${{ steps.terraform-output.outputs.application_url }}
          - **Dashboard**: ${{ steps.terraform-output.outputs.dashboard_url }}
          - **IP PÃºblica**: ${{ steps.terraform-output.outputs.public_ip }}
          
          ### ğŸ” Acceso SSH:
          \`\`\`bash
          ${{ steps.terraform-output.outputs.ssh_command }}
          \`\`\`
          
          ### ğŸ‘¤ Credenciales App:
          - Usuario: **admin**
          - ContraseÃ±a: **admin**
          
          ### ğŸ’° Costo Estimado: ~$7-10 USD/mes
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

  # ============================================
  # DESTRUCCIÃ“N DE INFRAESTRUCTURA
  # ============================================
  terraform-destroy:
    name: ğŸ’¥ Destroy Infrastructure
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.action == 'destroy' ||
      (github.event_name == 'push' && 
       contains(github.event.head_commit.message, '[DESTROY]'))
    
    environment: 
      name: azure-production

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ“‚ Terraform Init
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: terraform init

    - name: ğŸ’¥ Terraform Destroy
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        terraform destroy -auto-approve
        
    - name: âœ… Cleanup Complete
      run: echo "ğŸ—‘ï¸ Infraestructura eliminada exitosamente"

  # ============================================
  # CLEAN DEPLOY: Elimina RG y recrea todo
  # ============================================
  clean-deploy:
    name: ğŸ§¹ Clean Deploy (Delete RG + Recreate)
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'clean-deploy'
    
    environment: 
      name: azure-production
      url: ${{ steps.terraform-output.outputs.application_url }}

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ—‘ï¸ Force Delete Resource Group
      run: |
        echo "ğŸ§¹ Eliminando Resource Group completamente..."
        
        # Obtener el nombre del RG desde variables Terraform
        RG_NAME="RG-MICROSERVICES-DEMO-V3"
        
        # Verificar si existe el RG
        if az group show --name "$RG_NAME" >/dev/null 2>&1; then
          echo "ğŸ“ Resource Group '$RG_NAME' encontrado, eliminando..."
          
          # Forzar eliminaciÃ³n de todo el RG
          az group delete --name "$RG_NAME" --yes --no-wait
          
          echo "â³ Esperando eliminaciÃ³n completa..."
          # Esperar hasta que el RG sea eliminado completamente
          while az group show --name "$RG_NAME" >/dev/null 2>&1; do
            echo "â³ Esperando eliminaciÃ³n de $RG_NAME..."
            sleep 30
          done
          
          echo "âœ… Resource Group eliminado completamente"
        else
          echo "â„¹ï¸ Resource Group '$RG_NAME' no existe, continuando..."
        fi

    - name: ğŸ“‚ Terraform Init (Fresh Start)
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        echo "ğŸ†• Inicializando Terraform desde cero..."
        
        # Limpiar estado local si existe
        rm -f terraform.tfstate*
        rm -f .terraform.lock.hcl
        rm -rf .terraform/
        
        # Inicializar Terraform
        terraform init

    - name: ğŸš€ Terraform Plan & Apply (Complete Recreation)
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        echo "ğŸ“‹ Creando plan de infraestructura..."
        terraform plan -out=tfplan
        
        echo "ğŸš€ Desplegando infraestructura desde cero..."
        terraform apply -auto-approve tfplan
        
    - name: ğŸ“Š Get Fresh Terraform Outputs
      id: terraform-output
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        echo "ğŸ“Š Obteniendo outputs de la nueva infraestructura..."
        
        echo "application_url=$(terraform output -raw application_url)" >> $GITHUB_OUTPUT
        echo "dashboard_url=$(terraform output -raw dashboard_url)" >> $GITHUB_OUTPUT
        echo "ssh_command=$(terraform output -raw ssh_connection_command)" >> $GITHUB_OUTPUT
        echo "public_ip=$(terraform output -raw public_ip_address)" >> $GITHUB_OUTPUT
        
        echo ""
        echo "ğŸ‰ NUEVA INFRAESTRUCTURA DESPLEGADA:"
        echo "ğŸŒ App: $(terraform output -raw application_url)"
        echo "ğŸ“Š Dashboard: $(terraform output -raw dashboard_url)" 
        echo "ğŸ”§ SSH: $(terraform output -raw ssh_connection_command)"
        echo "ğŸ’° Costo estimado: ~$15-20/mes (Standard_B2s)"

    - name: âœ… Clean Deploy Complete
      run: |
        echo "ğŸ¯ CLEAN DEPLOY COMPLETADO EXITOSAMENTE"
        echo ""
        echo "âœ… Resource Group eliminado y recreado"
        echo "âœ… VM Standard_B2s desplegada (2 vCPUs, 4GB RAM)"
        echo "âœ… SSH configurado y listo"
        echo "âœ… Infraestructura estable para Docker builds"
        echo ""
        echo "ğŸš€ Ahora puedes ejecutar el Development Pipeline"