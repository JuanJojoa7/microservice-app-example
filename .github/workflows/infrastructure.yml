# ============================================
# PIPELINE DE INFRAESTRUCTURA - TERRAFORM
# ============================================
# Rebuild VM - SSH configuration fix

name: ğŸ—ï¸ Infrastructure Pipeline

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'AcciÃ³n a ejecutar'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - deploy
        - destroy
      
  push:
    branches:
      - feature/infrastructure-setup
    paths:
      - 'terraform/**'
  
  pull_request:
    paths:
      - 'terraform/**'

env:
  TF_VERSION: '1.5.0'
  WORKING_DIRECTORY: './terraform'

jobs:
  # ============================================
  # VALIDACIÃ“N Y PLAN
  # ============================================
  terraform-plan:
    name: ğŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    outputs:
      plan-exists: ${{ steps.plan.outputs.plan-exists }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ“‚ Terraform Init
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        terraform init
        
    - name: âœ… Terraform Validate
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: terraform validate

    - name: ğŸ¯ Terraform Format Check
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: terraform fmt -check=true -diff=true

    - name: ğŸ“‹ Terraform Plan
      id: plan
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        terraform plan -detailed-exitcode -out=tfplan
        echo "plan-exists=true" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: ğŸ“¤ Upload Plan
      if: steps.plan.outputs.plan-exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan
        path: ${{ env.WORKING_DIRECTORY }}/tfplan
        retention-days: 1

    - name: ğŸ’¬ Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const output = `
          ## ğŸ—ï¸ Terraform Plan Results
          
          âœ… **Terraform Format and Style**: ${{ steps.plan.outcome }}
          âœ… **Terraform Initialization**: Successful
          âœ… **Terraform Validation**: Successful
          âœ… **Terraform Plan**: ${{ steps.plan.outcome }}
          
          <details><summary>Show Plan Output</summary>
          
          \`\`\`
          ${{ steps.plan.outputs.stdout }}
          \`\`\`
          
          </details>
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

  # ============================================
  # DESPLIEGUE DE INFRAESTRUCTURA
  # ============================================
  terraform-deploy:
    name: ğŸš€ Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: >
      (github.event.inputs.action == 'deploy' || 
       (github.ref == 'refs/heads/feature/infrastructure-setup' && github.event_name == 'push')) &&
      needs.terraform-plan.outputs.plan-exists == 'true'
    
    environment: 
      name: azure-production
      url: ${{ steps.terraform-output.outputs.application_url }}

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ“¥ Download Plan
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan
        path: ${{ env.WORKING_DIRECTORY }}

    - name: ğŸ“‚ Terraform Init
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: terraform init

    - name: ğŸš€ Terraform Apply
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        terraform apply -auto-approve tfplan
        
    - name: ğŸ“Š Get Terraform Outputs
      id: terraform-output
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        echo "application_url=$(terraform output -raw application_url)" >> $GITHUB_OUTPUT
        echo "dashboard_url=$(terraform output -raw dashboard_url)" >> $GITHUB_OUTPUT
        echo "ssh_command=$(terraform output -raw ssh_connection_command)" >> $GITHUB_OUTPUT
        echo "public_ip=$(terraform output -raw public_ip_address)" >> $GITHUB_OUTPUT

    - name: ğŸ‰ Deployment Success
      run: |
        echo "ğŸ‰ Â¡DESPLIEGUE EXITOSO!"
        echo "ğŸŒ AplicaciÃ³n: ${{ steps.terraform-output.outputs.application_url }}"
        echo "ğŸ“Š Dashboard: ${{ steps.terraform-output.outputs.dashboard_url }}"
        echo "ğŸ”— SSH: ${{ steps.terraform-output.outputs.ssh_command }}"
        echo "ğŸ“± IP: ${{ steps.terraform-output.outputs.public_ip }}"

    - name: ğŸ’¬ Post Success Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const output = `
          ## ğŸ‰ Despliegue Exitoso!
          
          ### ğŸŒ AplicaciÃ³n Desplegada:
          - **AplicaciÃ³n**: ${{ steps.terraform-output.outputs.application_url }}
          - **Dashboard**: ${{ steps.terraform-output.outputs.dashboard_url }}
          - **IP PÃºblica**: ${{ steps.terraform-output.outputs.public_ip }}
          
          ### ğŸ” Acceso SSH:
          \`\`\`bash
          ${{ steps.terraform-output.outputs.ssh_command }}
          \`\`\`
          
          ### ğŸ‘¤ Credenciales App:
          - Usuario: **admin**
          - ContraseÃ±a: **admin**
          
          ### ğŸ’° Costo Estimado: ~$7-10 USD/mes
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

  # ============================================
  # DESTRUCCIÃ“N DE INFRAESTRUCTURA
  # ============================================
  terraform-destroy:
    name: ğŸ’¥ Destroy Infrastructure
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.action == 'destroy' ||
      (github.event_name == 'push' && 
       contains(github.event.head_commit.message, '[DESTROY]'))
    
    environment: 
      name: azure-production

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ“‚ Terraform Init
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: terraform init

    - name: ğŸ’¥ Terraform Destroy
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        terraform destroy -auto-approve
        
    - name: âœ… Cleanup Complete
      run: echo "ğŸ—‘ï¸ Infraestructura eliminada exitosamente"