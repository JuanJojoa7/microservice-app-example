name: ğŸš€ Development Pipeline

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
        - deploy
        - test-only

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # TESTS COMPLETOS
  # ============================================
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js 16 (compatible with Vue 2)
      uses: actions/setup-node@v4
      with:
        node-version: '16'
        cache: 'npm'
        cache-dependency-path: |
          frontend/package.json
          todos-api/package.json

    - name: ğŸ”§ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ”§ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.19'

    - name: ğŸ”§ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # Frontend Tests
    - name: ğŸ¨ Test Frontend
      working-directory: ./frontend
      run: |
        echo "ğŸ¨ Validating Frontend structure..."
        [ -f "package.json" ] && echo "âœ… package.json exists"
        [ -f "index.html" ] && echo "âœ… index.html exists"
        [ -d "src" ] && echo "âœ… src directory exists"
        [ -f "src/main.js" ] && echo "âœ… main.js exists"
        echo "âœ… Frontend structure validated"

    # TODOs API Tests  
    - name: ğŸ“ Test TODOs API
      working-directory: ./todos-api
      run: |
        echo "ğŸ“ Validating TODOs API structure..."
        [ -f "package.json" ] && echo "âœ… package.json exists"
        [ -f "server.js" ] && echo "âœ… server.js exists"
        [ -f "routes.js" ] && echo "âœ… routes.js exists"
        [ -f "todoController.js" ] && echo "âœ… todoController.js exists"
        echo "âœ… TODOs API structure validated"

    # Users API Tests (Java)
    - name: ğŸ‘¥ Test Users API
      working-directory: ./users-api
      run: |
        echo "ğŸ‘¥ Validating Users API structure..."
        [ -f "pom.xml" ] && echo "âœ… pom.xml exists"
        [ -f "src/main/java/com/elgris/usersapi/UsersApiApplication.java" ] && echo "âœ… Main class exists"
        echo "âœ… Users API structure validated"

    # Auth API Tests (Go)
    - name: ğŸ” Test Auth API
      working-directory: ./auth-api
      run: |
        echo "ğŸ” Validating Auth API structure..."
        [ -f "main.go" ] && echo "âœ… main.go exists"
        [ -f "user.go" ] && echo "âœ… user.go exists"
        echo "âœ… Auth API structure validated"

    # Log Processor Tests (Python)
    - name: ğŸ“Š Test Log Processor
      working-directory: ./log-message-processor
      run: |
        echo "ğŸ“Š Validating Log Processor structure..."
        [ -f "main.py" ] && echo "âœ… main.py exists"
        [ -f "requirements.txt" ] && echo "âœ… requirements.txt exists"
        echo "âœ… Log Processor structure validated"

    # Docker Compose Test
    - name: ğŸ³ Test Docker Compose
      run: |
        echo "ğŸ³ Validating Docker Compose files..."
        
        if command -v docker-compose >/dev/null 2>&1; then
          echo "âœ… Using docker-compose (v1)"
          docker-compose -f docker-compose-simple.yml build
        elif docker compose version >/dev/null 2>&1; then
          echo "âœ… Using docker compose (v2)"
          docker compose -f docker-compose-simple.yml build
        else
          echo "ğŸ“¦ Installing docker-compose..."
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose -f docker-compose-simple.yml build
        fi
        
        echo "âœ… All images built successfully"

    # Pattern Scripts Test
    - name: ğŸ¯ Test Pattern Scripts
      run: |
        echo "ğŸ§ª Validating pattern scripts..."
        [ -s "presentacion-final.bat" ] && echo "âœ… presentacion-final.bat OK"
        [ -s "comparacion-patrones.bat" ] && echo "âœ… comparacion-patrones.bat OK" 
        [ -s "servicios.bat" ] && echo "âœ… servicios.bat OK"
        [ -s "haproxy-simple.cfg" ] && echo "âœ… haproxy-simple.cfg OK"
        [ -s "docker-compose-simple.yml" ] && echo "âœ… docker-compose-simple.yml OK"
        echo "âœ… All pattern files validated"

  # ============================================
  # DEPLOYMENT A AZURE VM
  # ============================================
  deploy:
    name: ğŸš€ Deploy to Azure VM
    runs-on: ubuntu-latest
    needs: test
    if: always() && github.event.inputs.action == 'deploy' && (needs.test.result == 'success' || needs.test.result == 'skipped')

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ“Š Get VM Information
      id: get-vm-info
      run: |
        echo "ğŸ” Buscando VM en Azure..."
        
        # Buscar la VM por nombre en el resource group (nombres exactos de Azure)
        VM_EXISTS=$(az vm show --name "vm-microservices-demo" --resource-group "RG-MICROSERVICES-DEMO-V2" --query "id" -o tsv 2>/dev/null || echo "")
        
        if [ -z "$VM_EXISTS" ]; then
          echo "âŒ VM no encontrada. Verificando nombres..."
          echo "ğŸ” Listando VMs disponibles:"
          az vm list --query "[].{Name:name, ResourceGroup:resourceGroup}" --output table
          echo "vm_exists=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Obtener IP pÃºblica
        VM_IP=$(az network public-ip show --name "pip-microservices-vm" --resource-group "RG-MICROSERVICES-DEMO-V2" --query "ipAddress" -o tsv)
        
        if [ -z "$VM_IP" ] || [ "$VM_IP" == "null" ]; then
          echo "âŒ No se pudo obtener la IP pÃºblica de la VM"
          echo "ğŸ” Listando IPs pÃºblicas:"
          az network public-ip list --query "[].{Name:name, ResourceGroup:resourceGroup, IP:ipAddress}" --output table
          exit 1
        fi
        
        echo "âœ… VM encontrada con IP: $VM_IP"
        echo "vm_ip=$VM_IP" >> $GITHUB_OUTPUT
        echo "application_url=http://$VM_IP" >> $GITHUB_OUTPUT
        echo "dashboard_url=http://$VM_IP:8404/stats" >> $GITHUB_OUTPUT
        echo "vm_exists=true" >> $GITHUB_OUTPUT

    - name: ğŸš€ Deploy to VM
      if: steps.get-vm-info.outputs.vm_exists == 'true'
      run: |
        echo "ğŸš€ Desplegando aplicaciÃ³n en la VM..."
        
        VM_IP="${{ steps.get-vm-info.outputs.vm_ip }}"
        echo "ğŸŒ VM IP: $VM_IP"
        
        # Configurar SSH sin interacciÃ³n
        echo "ğŸ”‘ Configurando SSH..."
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Instalar sshpass para usar contraseÃ±a
        sudo apt-get update -qq
        sudo apt-get install -y sshpass
        
        # FunciÃ³n para ejecutar comandos SSH con retry
        execute_ssh() {
          local max_attempts=3
          local attempt=1
          local delay=15
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ”„ Intento $attempt de $max_attempts..."
            
            if sshpass -p 'DevOps123!' ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 azureuser@$VM_IP "$1"; then
              echo "âœ… Comando ejecutado exitosamente"
              return 0
            else
              echo "âŒ Intento $attempt fallÃ³"
              if [ $attempt -lt $max_attempts ]; then
                echo "â³ Esperando ${delay}s antes del siguiente intento..."
                sleep $delay
              fi
              attempt=$((attempt + 1))
            fi
          done
          
          echo "âŒ Todos los intentos SSH fallaron"
          return 1
        }
        
        echo "ğŸ“¦ Ejecutando deployment..."
        
        # Script de deployment remoto
        DEPLOY_SCRIPT='
        set -e
        echo "ğŸ  Iniciando deployment en la VM..."
        
        # Navegar al directorio home
        cd /home/azureuser
        
        # Actualizar sistema bÃ¡sico
        echo "ğŸ“¦ Actualizando sistema..."
        sudo apt-get update -qq
        
        # Instalar Git si no estÃ¡
        if ! command -v git &> /dev/null; then
          echo "ğŸ“¥ Instalando Git..."
          sudo apt-get install -y git
        fi
        
        # Clonar o actualizar repositorio
        echo "ğŸ“ Preparando cÃ³digo..."
        if [ -d "microservice-app-example" ]; then
          cd microservice-app-example
          echo "ğŸ”„ Actualizando repositorio existente..."
          git fetch origin || echo "âš ï¸  Fetch fallÃ³, continuando..."
          git reset --hard origin/feature/infrastructure-setup || git reset --hard HEAD
        else
          echo "ğŸ“¥ Clonando repositorio..."
          git clone -b feature/infrastructure-setup https://github.com/JuanJojoa7/microservice-app-example.git || {
            echo "âŒ Error clonando repositorio"
            exit 1
          }
          cd microservice-app-example
        fi
        
        # Verificar que tenemos el archivo docker-compose
        if [ ! -f "docker-compose-simple.yml" ]; then
          echo "âŒ docker-compose-simple.yml no encontrado"
          ls -la
          exit 1
        fi
        
        echo "ğŸ“‹ Archivos disponibles:"
        ls -la *.yml *.yaml 2>/dev/null || echo "No hay archivos YAML"
        
        # Asegurar que Docker estÃ© funcionando
        echo "ğŸ³ Verificando Docker..."
        sudo systemctl start docker
        sudo systemctl enable docker
        
        # Limpiar contenedores anteriores
        echo "ğŸ§¹ Limpiando deployment anterior..."
        sudo docker-compose -f docker-compose-simple.yml down --remove-orphans 2>/dev/null || echo "No hay contenedores previos"
        
        # Descargar imÃ¡genes
        echo "ğŸ“¥ Descargando imÃ¡genes Docker..."
        sudo docker-compose -f docker-compose-simple.yml pull || echo "âš ï¸  Pull fallÃ³, continuando con build"
        
        # Construir e iniciar
        echo "ğŸš€ Iniciando aplicaciÃ³n..."
        sudo docker-compose -f docker-compose-simple.yml up -d --build
        
        # Esperar y verificar
        echo "â³ Esperando inicializaciÃ³n (60s)..."
        sleep 60
        
        echo "ğŸ“Š Estado final de contenedores:"
        sudo docker ps
        
        echo "ğŸŒ URLs de acceso:"
        PUBLIC_IP=$(curl -s ifconfig.me 2>/dev/null || echo "IP_NOT_FOUND")
        echo "â€¢ AplicaciÃ³n: http://$PUBLIC_IP"
        echo "â€¢ Dashboard: http://$PUBLIC_IP:8404/stats"
        
        echo "âœ… Deployment completado exitosamente"
        '
        
        # Ejecutar el script de deployment
        if execute_ssh "$DEPLOY_SCRIPT"; then
          echo "ğŸ‰ Â¡Deployment exitoso!"
          echo "ğŸŒ AplicaciÃ³n disponible en: http://$VM_IP"
          echo "ğŸ“Š Dashboard HAProxy: http://$VM_IP:8404/stats"
        else
          echo "âŒ Deployment fallÃ³ despuÃ©s de varios intentos"
          exit 1
        fi

    - name: âœ… Verify Deployment
      if: steps.get-vm-info.outputs.vm_exists == 'true'
      run: |
        VM_IP="${{ steps.get-vm-info.outputs.vm_ip }}"
        
        echo "ğŸ” Verificando despliegue..."
        sleep 15
        
        # Verificar que la aplicaciÃ³n responde
        echo "ğŸŒ Probando conexiÃ³n a la aplicaciÃ³n..."
        if curl -f -s -o /dev/null http://$VM_IP; then
          echo "âœ… AplicaciÃ³n accesible en: http://$VM_IP"
        else
          echo "âš ï¸  AplicaciÃ³n no responde inmediatamente (normal en primer deployment)"
        fi
        
        # Verificar dashboard HAProxy
        echo "ğŸ“Š Probando dashboard HAProxy..."
        if curl -f -s -o /dev/null http://$VM_IP:8404/stats; then
          echo "âœ… Dashboard accesible en: http://$VM_IP:8404/stats"
        else
          echo "âš ï¸  Dashboard no responde (puede estar inicializando)"
        fi

  # ============================================
  # REPORTE FINAL
  # ============================================
  report:
    name: ğŸ“Š Final Report
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()

    steps:
    - name: ğŸ“‹ Generate Report
      run: |
        echo "# ğŸ¯ DEPLOYMENT PIPELINE REPORT"
        echo ""
        echo "## ğŸ“Š RESULTADOS:"
        echo "ğŸ§ª Tests: ${{ needs.test.result }}"
        echo "ğŸš€ Deploy: ${{ needs.deploy.result }}"
        echo ""
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "## ğŸŒ ACCESO A LA APLICACIÃ“N:"
          echo "â€¢ **AplicaciÃ³n Principal**: http://52.167.206.251"
          echo "â€¢ **Dashboard HAProxy**: http://52.167.206.251:8404/stats"
          echo "â€¢ **Usuario Dashboard**: admin/admin"
          echo ""
          echo "## ğŸ¯ PATRONES IMPLEMENTADOS:"
          echo "âœ… **Circuit Breaker**: HAProxy maneja fallos automÃ¡ticamente"
          echo "âœ… **Cache Aside**: Redis optimiza performance"
          echo "âœ… **Load Balancing**: DistribuciÃ³n de carga"
          echo "âœ… **Service Discovery**: ConfiguraciÃ³n automÃ¡tica"
          echo ""
          echo "## ğŸ’° COSTO ESTIMADO:"
          echo "â€¢ VM Standard_B1s: ~$7-10 USD/mes"
          echo "â€¢ Total infraestructura: ~$10 USD/mes"
        fi
        echo ""
        echo "## ğŸ“ DEMO LOCAL:"
        echo "Para comparar patrones, ejecuta: \`presentacion-final.bat\`"