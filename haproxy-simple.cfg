global
    daemon
    log stdout local0 info

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    log global

# Frontend Load Balancer with Circuit Breaker
frontend microservices_lb
    bind *:80
    
    # Route based on path
    acl is_auth path_beg /login /auth
    acl is_users path_beg /users
    acl is_todos path_beg /todos
    
    # Route to backends
    use_backend auth_backend if is_auth
    use_backend users_backend if is_users
    use_backend todos_backend if is_todos
    default_backend frontend_backend

# Auth API with Circuit Breaker
backend auth_backend
    option httpchk GET /version
    balance roundrobin
    server auth1 auth-api:8000 check inter 2s fall 3 rise 2

# Users API with Circuit Breaker
backend users_backend
    option httpchk GET /users/
    balance roundrobin
    server users1 users-api:8083 check inter 2s fall 3 rise 2

# TODOs API with Circuit Breaker
backend todos_backend
    balance roundrobin
    server todos1 todos-api:8082 check inter 2s fall 3 rise 2

# Frontend
backend frontend_backend
    option httpchk GET /
    balance roundrobin
    server frontend1 frontend:8080 check inter 2s fall 3 rise 2

# Stats dashboard
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 5s
    stats show-legends
    stats admin if TRUE
